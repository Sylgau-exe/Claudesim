<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XVQTC9C1DE"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag("js", new Date());
gtag("config", "G-XVQTC9C1DE");
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ClaudeSim ‚Äî Debrief Report</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg-primary:#0a0f1e;--bg-secondary:#0f172a;--bg-card:#151d30;--text-primary:#f1f5f9;--text-secondary:#cbd5e1;--text-muted:#94a3b8;--accent:#2563eb;--accent-light:#3b82f6;--accent-glow:rgba(37,99,235,0.3);--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--border:rgba(255,255,255,0.08);}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Inter',sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;}
.container{max-width:900px;margin:0 auto;padding:40px 24px;}
a{color:var(--accent-light);text-decoration:none;}
nav{background:var(--bg-secondary);border-bottom:1px solid var(--border);padding:14px 24px;display:flex;align-items:center;justify-content:space-between;}
.nav-logo{font-size:20px;font-weight:800;} .nav-logo span{color:var(--accent-light);}
.btn{padding:10px 20px;border-radius:8px;font-weight:600;font-size:14px;cursor:pointer;border:none;font-family:inherit;transition:all 0.2s;}
.btn-primary{background:linear-gradient(135deg,#1e3a5f,#2563eb);color:white;}

/* DEBRIEF HEADER */
.debrief-header{text-align:center;padding:40px 0 32px;}
.debrief-header h1{font-size:32px;font-weight:800;margin-bottom:8px;}
.debrief-header p{font-size:16px;color:var(--text-secondary);}

/* SCORE RING */
.score-ring{width:160px;height:160px;margin:32px auto;position:relative;}
.score-ring svg{width:100%;height:100%;transform:rotate(-90deg);}
.score-ring circle{fill:none;stroke-width:12;stroke-linecap:round;}
.score-ring .bg{stroke:rgba(255,255,255,0.06);}
.score-ring .fill{stroke:var(--accent);transition:stroke-dashoffset 1.5s ease;}
.score-value{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.score-value .num{font-size:48px;font-weight:800;color:var(--accent-light);}
.score-value .label{font-size:13px;color:var(--text-muted);}

/* META */
.meta-row{display:flex;justify-content:center;gap:32px;margin-bottom:40px;}
.meta-item{text-align:center;}
.meta-item .val{font-size:20px;font-weight:700;}
.meta-item .label{font-size:12px;color:var(--text-muted);margin-top:2px;}

/* COMPETENCIES */
.comp-section{margin-bottom:40px;}
.comp-section h2{font-size:20px;font-weight:700;margin-bottom:16px;}
.comp-bars{display:grid;grid-template-columns:1fr;gap:12px;}
.comp-row{display:flex;align-items:center;gap:12px;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:14px 16px;}
.comp-row .code{font-size:14px;font-weight:800;color:var(--accent-light);width:28px;}
.comp-row .name{font-size:13px;color:var(--text-secondary);width:140px;flex-shrink:0;}
.comp-row .bar-bg{flex:1;height:8px;background:rgba(255,255,255,0.06);border-radius:4px;overflow:hidden;}
.comp-row .bar-fill{height:100%;background:var(--accent);border-radius:4px;transition:width 1s ease;}
.comp-row .score{font-size:14px;font-weight:700;width:32px;text-align:right;}

/* STRENGTHS / IMPROVEMENTS */
.analysis-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:40px;}
.analysis-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:24px;}
.analysis-card h3{font-size:16px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px;}
.analysis-card ul{list-style:none;}
.analysis-card li{padding:8px 0;font-size:14px;color:var(--text-secondary);display:flex;align-items:flex-start;gap:8px;line-height:1.5;}
.analysis-card li .icon{flex-shrink:0;margin-top:2px;}

/* TECHNIQUES */
.techniques{margin-bottom:40px;}
.techniques h2{font-size:20px;font-weight:700;margin-bottom:16px;}
.tech-grid{display:flex;flex-wrap:wrap;gap:8px;}
.tech-tag{padding:6px 14px;border-radius:999px;font-size:12px;font-weight:600;}
.tech-tag.used{background:rgba(16,185,129,0.15);color:#34d399;}
.tech-tag.missed{background:rgba(239,68,68,0.15);color:#f87171;}

/* RECOMMENDATION */
.reco-card{background:var(--bg-card);border:1px solid var(--border-accent);border-radius:12px;padding:24px;margin-bottom:40px;border-left:4px solid var(--accent);}
.reco-card h3{font-size:16px;font-weight:700;margin-bottom:8px;}
.reco-card p{font-size:14px;color:var(--text-secondary);line-height:1.6;}

/* SCORE EXPLAINER */
.score-explainer{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px 24px;margin:0 auto 32px;max-width:680px;cursor:pointer;}
.score-explainer summary{font-size:14px;font-weight:600;color:var(--accent-light);list-style:none;display:flex;align-items:center;gap:8px;}
.score-explainer summary::-webkit-details-marker{display:none;}
.score-explainer summary::before{content:'‚ÑπÔ∏è';}
.score-explainer summary::after{content:'‚ñ∏';margin-left:auto;transition:transform 0.2s;}
.score-explainer[open] summary::after{transform:rotate(90deg);}
.score-explainer .explain-body{margin-top:14px;font-size:13px;color:var(--text-secondary);line-height:1.7;}
.score-explainer .explain-body strong{color:var(--text-primary);}
.score-explainer .score-compare{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px;}
.score-compare-item{background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:8px;padding:12px 14px;}
.score-compare-item .sc-label{font-size:11px;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-muted);margin-bottom:4px;}
.score-compare-item .sc-desc{font-size:13px;color:var(--text-secondary);line-height:1.5;}

.cta-row{text-align:center;padding:20px 0 40px;}
.cta-row .btn{margin:0 8px;}
@media(max-width:768px){.analysis-grid{grid-template-columns:1fr;}.meta-row{flex-direction:column;gap:16px;}}
</style>
</head>
<body>

<nav>
  <a href="/" class="nav-logo">Claude<span>Sim</span></a>
  <a href="/dashboard">‚Üê Back to Dashboard</a>
</nav>

<div class="container">
  <div class="debrief-header">
    <h1>üéØ Debrief Report</h1>
    <p id="debriefScenario">Simulation Complete</p>
  </div>

  <!-- SCORE RING -->
  <div class="score-ring">
    <svg viewBox="0 0 120 120"><circle class="bg" cx="60" cy="60" r="52"/><circle class="fill" id="scoreCircle" cx="60" cy="60" r="52" stroke-dasharray="326.7" stroke-dashoffset="326.7"/></svg>
    <div class="score-value"><div class="num" id="scoreNum">-</div><div class="label">Global Score</div></div>
  </div>

  <!-- SCORE EXPLAINER -->
  <details class="score-explainer" id="scoreExplainer">
    <summary id="explainerTitle">How is my score calculated?</summary>
    <div class="explain-body">
      <p id="explainIntro">Your <strong>Global Score</strong> and your <strong>Prompt Scores</strong> measure different things ‚Äî it's normal for them to differ significantly.</p>
      <div class="score-compare">
        <div class="score-compare-item">
          <div class="sc-label" id="scLabel1">Global Score (0-100)</div>
          <div class="sc-desc" id="scDesc1">Measures your <strong>overall competency</strong> across 6 dimensions: Clarity, Advanced Techniques, Strategic Iteration, Critical Thinking, Efficiency, and Ethics. ARIA evaluates your approach, not just your prompts. You can score well here even with imperfect prompts ‚Äî if your reasoning and strategy are sound.</div>
        </div>
        <div class="score-compare-item">
          <div class="sc-label" id="scLabel2">Prompt Scores (0-100 each)</div>
          <div class="sc-desc" id="scDesc2">Measures the <strong>technical quality of each individual prompt</strong> ‚Äî specificity, structure, context, constraints, and formatting. These are intentionally strict. A first attempt at prompting typically scores 15-35. Improvement through iteration is the goal.</div>
        </div>
      </div>
      <p style="margin-top:14px;" id="explainExample"><strong>Example:</strong> A learner writes vague prompts (Prompt Score: 20) but demonstrates good critical thinking by questioning Claude's output, iterating strategically, and recognizing limitations ‚Üí Global Score: 55. The prompts need work, but the competencies are emerging.</p>
    </div>
  </details>

  <!-- PROMPT PROGRESSION -->
  <div id="promptProgression" style="margin-bottom:32px;display:none;">
    <h2 style="font-size:18px;font-weight:700;margin-bottom:16px;text-align:center;">Prompt Quality Progression</h2>
    <div id="promptBars" style="display:flex;align-items:flex-end;justify-content:center;gap:8px;height:120px;margin-bottom:8px;"></div>
    <div style="text-align:center;font-size:13px;color:var(--text-muted);" id="promptAvgLabel"></div>
  </div>

  <div class="meta-row">
    <div class="meta-item"><div class="val" id="metaPrompts">-</div><div class="label">Prompts Used</div></div>
    <div class="meta-item"><div class="val" id="metaDuration">-</div><div class="label">Minutes</div></div>
  </div>

  <!-- COMPETENCIES -->
  <div class="comp-section">
    <h2>Competency Scores</h2>
    <div class="comp-bars" id="compBars"></div>
  </div>

  <!-- STRENGTHS + IMPROVEMENTS -->
  <div class="analysis-grid">
    <div class="analysis-card">
      <h3>üí™ Strengths</h3>
      <ul id="strengthsList"></ul>
    </div>
    <div class="analysis-card">
      <h3>üéØ Areas for Improvement</h3>
      <ul id="improvementsList"></ul>
    </div>
  </div>

  <!-- TECHNIQUES -->
  <div class="techniques">
    <h2>Techniques Analysis</h2>
    <div class="tech-grid" id="techGrid"></div>
  </div>

  <!-- RECOMMENDATION -->
  <div class="reco-card">
    <h3>üìã Next Steps</h3>
    <p id="recoText">Loading...</p>
  </div>

  <div class="cta-row">
    <button class="btn btn-primary" id="retryBtn" onclick="retryScenario()" style="display:none;">üîÑ Try Again ‚Äî Improve Your Score</button>
    <a href="/dashboard" class="btn" style="background:var(--bg-card);color:var(--text-primary);border:1px solid var(--border);">Back to Dashboard</a>
    <button class="btn" style="background:var(--bg-card);color:var(--text-primary);border:1px solid var(--border);" onclick="window.print()">üñ® Print Report</button>
  </div>
</div>

<script>
const lang = localStorage.getItem('claudesim_lang') || 'en';
const COMP_NAMES = { c1: 'Clarity', c2: 'Advanced Techniques', c3: 'Strategic Iteration', c4: 'Critical Thinking', c5: 'Efficiency', c6: 'Ethics & Limits' };
const COMP_NAMES_FR = { c1: 'Clart√©', c2: 'Techniques avanc√©es', c3: 'It√©ration strat√©gique', c4: 'Pens√©e critique', c5: 'Efficacit√©', c6: '√âthique & Limites' };

const TR = {
  en: { debrief_title: 'üéØ Debrief Report', sim_complete: 'Simulation Complete', global_score: 'Global Score', prompt_progression: 'Prompt Quality Progression', prompts_used: 'Prompts Used', minutes: 'Minutes', comp_scores: 'Competency Scores', strengths: 'üí™ Strengths', improvements: 'üéØ Areas for Improvement', techniques: 'Techniques Analysis', next_steps: 'üìã Next Steps', no_data: 'No debrief data found. Complete a simulation first.', try_again: 'üîÑ Try Again ‚Äî Improve Your Score', back_dash: 'Back to Dashboard', print_report: 'üñ® Print Report', needs_practice: '‚ö†Ô∏è Needs practice', getting_there: 'üí° Getting there', good: 'üëç Good', excellent: 'üåü Excellent', avg_prompt: 'Average Prompt Score',
    explainer_title: 'How is my score calculated?',
    explain_intro: 'Your <strong>Global Score</strong> and your <strong>Prompt Scores</strong> measure different things ‚Äî it\'s normal for them to differ significantly.',
    sc_label1: 'Global Score (0-100)', sc_desc1: 'Measures your <strong>overall competency</strong> across 6 dimensions: Clarity, Advanced Techniques, Strategic Iteration, Critical Thinking, Efficiency, and Ethics. ARIA evaluates your approach, not just your prompts. You can score well here even with imperfect prompts ‚Äî if your reasoning and strategy are sound.',
    sc_label2: 'Prompt Scores (0-100 each)', sc_desc2: 'Measures the <strong>technical quality of each individual prompt</strong> ‚Äî specificity, structure, context, constraints, and formatting. These are intentionally strict. A first attempt at prompting typically scores 15-35. Improvement through iteration is the goal.',
    explain_example: '<strong>Example:</strong> A learner writes vague prompts (Prompt Score: 20) but demonstrates good critical thinking by questioning Claude\'s output, iterating strategically, and recognizing limitations ‚Üí Global Score: 55. The prompts need work, but the competencies are emerging.'
  },
  fr: { debrief_title: 'üéØ Rapport de d√©brief', sim_complete: 'Simulation termin√©e', global_score: 'Score global', prompt_progression: 'Progression de la qualit√© des prompts', prompts_used: 'Prompts utilis√©s', minutes: 'Minutes', comp_scores: 'Scores des comp√©tences', strengths: 'üí™ Forces', improvements: 'üéØ Points √† am√©liorer', techniques: 'Analyse des techniques', next_steps: 'üìã Prochaines √©tapes', no_data: 'Aucune donn√©e de d√©brief trouv√©e. Compl√©tez une simulation d\'abord.', try_again: 'üîÑ R√©essayer ‚Äî Am√©liorer votre score', back_dash: 'Retour au tableau de bord', print_report: 'üñ® Imprimer le rapport', needs_practice: '‚ö†Ô∏è √Ä travailler', getting_there: 'üí° En progression', good: 'üëç Bien', excellent: 'üåü Excellent', avg_prompt: 'Score moyen des prompts',
    explainer_title: 'Comment mon score est-il calcul√© ?',
    explain_intro: 'Votre <strong>Score global</strong> et vos <strong>Scores de prompts</strong> mesurent des choses diff√©rentes ‚Äî il est normal qu\'ils diff√®rent significativement.',
    sc_label1: 'Score global (0-100)', sc_desc1: 'Mesure votre <strong>comp√©tence globale</strong> sur 6 dimensions : Clart√©, Techniques avanc√©es, It√©ration strat√©gique, Pens√©e critique, Efficacit√© et √âthique. ARIA √©value votre approche, pas seulement vos prompts. Vous pouvez bien scorer ici m√™me avec des prompts imparfaits ‚Äî si votre raisonnement et votre strat√©gie sont solides.',
    sc_label2: 'Scores de prompts (0-100 chacun)', sc_desc2: 'Mesure la <strong>qualit√© technique de chaque prompt individuel</strong> ‚Äî sp√©cificit√©, structure, contexte, contraintes et formatage. Ces scores sont intentionnellement stricts. Un premier essai de prompting score typiquement 15-35. L\'am√©lioration par l\'it√©ration est l\'objectif.',
    explain_example: '<strong>Exemple :</strong> Un apprenant √©crit des prompts vagues (Score prompt : 20) mais d√©montre une bonne pens√©e critique en questionnant la r√©ponse de Claude, en it√©rant strat√©giquement et en reconnaissant les limites ‚Üí Score global : 55. Les prompts ont besoin de travail, mais les comp√©tences √©mergent.'
  }
};
const t = TR[lang] || TR.en;

let scenarioIdForRetry = null;

function init() {
  // Apply language
  document.querySelector('.debrief-header h1').textContent = t.debrief_title;
  document.getElementById('debriefScenario').textContent = t.sim_complete;
  document.querySelector('.score-value .label').textContent = t.global_score;
  document.querySelector('#promptProgression h2').textContent = t.prompt_progression;
  document.querySelectorAll('.meta-item .label')[0].textContent = t.prompts_used;
  document.querySelectorAll('.meta-item .label')[1].textContent = t.minutes;
  document.querySelector('.comp-section h2').textContent = t.comp_scores;
  document.querySelectorAll('.analysis-card h3')[0].textContent = t.strengths;
  document.querySelectorAll('.analysis-card h3')[1].textContent = t.improvements;
  document.querySelector('.techniques h2').textContent = t.techniques;
  document.querySelector('.reco-card h3').textContent = t.next_steps;
  document.getElementById('retryBtn').textContent = t.try_again;
  document.querySelectorAll('.cta-row .btn')[1].textContent = t.back_dash;
  document.querySelectorAll('.cta-row .btn')[2].textContent = t.print_report;
  // Score explainer
  document.getElementById('explainerTitle').textContent = t.explainer_title;
  document.getElementById('explainIntro').innerHTML = t.explain_intro;
  document.getElementById('scLabel1').textContent = t.sc_label1;
  document.getElementById('scDesc1').innerHTML = t.sc_desc1;
  document.getElementById('scLabel2').textContent = t.sc_label2;
  document.getElementById('scDesc2').innerHTML = t.sc_desc2;
  document.getElementById('explainExample').innerHTML = t.explain_example;

  const stored = localStorage.getItem('claudesim_debrief');
  const scores = localStorage.getItem('claudesim_prompt_scores');
  if (stored) {
    try {
      const debrief = JSON.parse(stored);
      renderDebrief(debrief);
      if (debrief.scenarioId) {
        scenarioIdForRetry = debrief.scenarioId;
        document.getElementById('retryBtn').style.display = 'inline-block';
      }
    } catch(e) { console.error('Parse error', e); }
  } else {
    document.getElementById('scoreNum').textContent = '?';
    document.getElementById('recoText').textContent = 'No debrief data found. Complete a simulation first.';
  }
  if (scores) {
    try { renderPromptScores(JSON.parse(scores)); } catch(e) {}
  }
}

function renderPromptScores(scores) {
  if (!scores || scores.length === 0) return;
  const container = document.getElementById('promptProgression');
  const barsEl = document.getElementById('promptBars');
  container.style.display = 'block';

  const avg = Math.round(scores.reduce((a,b) => a+b, 0) / scores.length);

  barsEl.innerHTML = scores.map((s, i) => {
    let color = '#f87171';
    if (s >= 80) color = '#34d399';
    else if (s >= 60) color = '#3b82f6';
    else if (s >= 40) color = '#fbbf24';
    return `<div style="display:flex;flex-direction:column;align-items:center;gap:4px;">
      <span style="font-size:12px;font-weight:700;color:${color};">${s}</span>
      <div style="width:40px;background:${color};border-radius:4px;height:${Math.max(s, 5)}px;transition:height 0.5s;"></div>
      <span style="font-size:11px;color:var(--text-muted);">P${i+1}</span>
    </div>`;
  }).join('');

  let tierLabel = t.needs_practice;
  if (avg >= 80) tierLabel = t.excellent;
  else if (avg >= 60) tierLabel = t.good;
  else if (avg >= 40) tierLabel = t.getting_there;

  document.getElementById('promptAvgLabel').innerHTML = `${t.avg_prompt}: <strong style="color:var(--accent-light);font-size:18px;">${avg}/100</strong> ‚Äî ${tierLabel}`;
}

function retryScenario() {
  if (scenarioIdForRetry) {
    window.location.href = `/simulation?scenario=${scenarioIdForRetry}`;
  } else {
    window.location.href = '/dashboard';
  }
}

function renderDebrief(d) {
  // Score ring
  const score = d.scoreGlobal || 0;
  document.getElementById('scoreNum').textContent = score;
  const circle = document.getElementById('scoreCircle');
  const offset = 326.7 - (326.7 * score / 100);
  setTimeout(() => { circle.style.strokeDashoffset = offset; }, 200);

  // Meta
  document.getElementById('metaPrompts').textContent = d.promptCount || '-';
  document.getElementById('metaDuration').textContent = d.duration || '-';

  // Competencies
  const names = lang === 'fr' ? COMP_NAMES_FR : COMP_NAMES;
  const compBars = document.getElementById('compBars');
  compBars.innerHTML = Object.entries(d.scores || {}).map(([key, val]) => `
    <div class="comp-row">
      <span class="code">${key.toUpperCase()}</span>
      <span class="name">${names[key] || key}</span>
      <div class="bar-bg"><div class="bar-fill" style="width:${val/5*100}%"></div></div>
      <span class="score">${val}/5</span>
    </div>
  `).join('');

  // Strengths
  document.getElementById('strengthsList').innerHTML = (d.strengths || []).map(s => `<li><span class="icon">‚úÖ</span>${s}</li>`).join('');
  document.getElementById('improvementsList').innerHTML = (d.improvements || []).map(s => `<li><span class="icon">üîß</span>${s}</li>`).join('');

  // Techniques
  const techGrid = document.getElementById('techGrid');
  techGrid.innerHTML = 
    (d.techniquesUsed || []).map(t => `<span class="tech-tag used">‚úì ${t}</span>`).join('') +
    (d.techniquesMissed || []).map(t => `<span class="tech-tag missed">‚úó ${t}</span>`).join('');

  // Recommendation
  document.getElementById('recoText').textContent = d.recommendation || '';
}

init();
</script>
</body>
</html>
