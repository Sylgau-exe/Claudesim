<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XVQTC9C1DE"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag("js", new Date());
gtag("config", "G-XVQTC9C1DE");
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ClaudeSim â€” Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg-primary:#0a0f1e;--bg-secondary:#0f172a;--bg-card:#151d30;--text-primary:#f1f5f9;--text-secondary:#cbd5e1;--text-muted:#94a3b8;--accent:#2563eb;--accent-light:#3b82f6;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--border:rgba(255,255,255,0.08);--border-accent:rgba(37,99,235,0.3);}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Inter',sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;}
a{color:var(--accent-light);text-decoration:none;}
.container{max-width:1200px;margin:0 auto;padding:0 24px;}

nav{background:var(--bg-secondary);border-bottom:1px solid var(--border);padding:14px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;}
.nav-logo{font-size:20px;font-weight:800;} .nav-logo span{color:var(--accent-light);}
.nav-badge{background:var(--danger);color:white;padding:3px 10px;border-radius:999px;font-size:11px;font-weight:700;margin-left:8px;}
.nav-right a{font-size:14px;color:var(--text-secondary);margin-left:20px;}

main{padding:32px 0;}
h1{font-size:24px;font-weight:800;margin-bottom:24px;}
.btn{padding:8px 16px;border-radius:6px;font-weight:600;font-size:13px;cursor:pointer;border:none;font-family:inherit;transition:all 0.2s;}
.btn-primary{background:linear-gradient(135deg,#1e3a5f,#2563eb);color:white;}
.btn-danger{background:var(--danger);color:white;font-size:11px;padding:4px 10px;}
.btn-sm{padding:4px 10px;font-size:11px;}

/* STAT CARDS */
.stats-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:16px;margin-bottom:32px;}
.stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;position:relative;overflow:hidden;}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--accent);}
.stat-card .val{font-size:32px;font-weight:800;background:linear-gradient(135deg,#3b82f6,#60a5fa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.stat-card .label{font-size:12px;color:var(--text-muted);margin-top:4px;}
.stat-card .sub{font-size:11px;color:var(--success);margin-top:6px;}

/* TABS */
.tabs{display:flex;gap:0;margin-bottom:24px;border-bottom:1px solid var(--border);}
.tab{padding:12px 24px;font-size:14px;font-weight:600;color:var(--text-muted);cursor:pointer;border-bottom:2px solid transparent;transition:all 0.2s;}
.tab.active{color:var(--accent-light);border-bottom-color:var(--accent);}
.tab-content{display:none;}.tab-content.active{display:block;}

/* TABLE */
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;font-size:13px;}
th{text-align:left;font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);padding:10px 12px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg-primary);}
td{padding:10px 12px;border-bottom:1px solid var(--border);}
tr:hover td{background:rgba(37,99,235,0.04);}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:10px;font-weight:700;text-transform:uppercase;}
.badge.free{background:rgba(100,116,139,0.2);color:var(--text-muted);}
.badge.pro_monthly{background:rgba(37,99,235,0.15);color:var(--accent-light);}
.badge.pro_lifetime{background:rgba(16,185,129,0.15);color:#34d399;}
.badge.admin{background:rgba(245,158,11,0.15);color:#fbbf24;}

/* SCENARIO TABLE */
.sc-bar-bg{width:80px;height:6px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden;display:inline-block;vertical-align:middle;margin-left:8px;}
.sc-bar{height:100%;background:var(--accent);border-radius:3px;}

/* EDIT MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);z-index:200;align-items:center;justify-content:center;}
.modal-overlay.active{display:flex;}
.modal{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:32px;width:100%;max-width:480px;}
.modal h2{font-size:20px;font-weight:700;margin-bottom:20px;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;}
.form-group{margin-bottom:12px;}
.form-group label{display:block;font-size:12px;color:var(--text-muted);margin-bottom:4px;font-weight:500;}
.form-group input,.form-group select{width:100%;padding:8px 12px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:13px;font-family:inherit;}
.form-group select{cursor:pointer;}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px;}

.toast{position:fixed;top:60px;right:20px;padding:12px 20px;border-radius:8px;font-size:14px;z-index:300;transform:translateX(150%);transition:transform 0.3s;}
.toast.show{transform:translateX(0);}.toast.success{background:#065f46;color:#a7f3d0;border:1px solid #10b981;}.toast.error{background:#7f1d1d;color:#fecaca;border:1px solid #ef4444;}

@media(max-width:768px){.stats-grid{grid-template-columns:repeat(2,1fr);}.form-row{grid-template-columns:1fr;}}
</style>
</head>
<body>

<nav>
  <div style="display:flex;align-items:center;">
    <a href="/" class="nav-logo">Claude<span>Sim</span></a>
    <span class="nav-badge">ADMIN</span>
  </div>
  <div class="nav-right">
    <a href="/dashboard">User Dashboard</a>
    <a href="#" onclick="logout()">Logout</a>
  </div>
</nav>

<main class="container">
  <h1>Admin Dashboard</h1>

  <!-- STATS -->
  <div class="stats-grid" id="statsGrid">
    <div class="stat-card"><div class="val" id="sUsers">0</div><div class="label">Total Users</div><div class="sub" id="sNewUsers">+0 this week</div></div>
    <div class="stat-card"><div class="val" id="sSessions">0</div><div class="label">Total Sessions</div><div class="sub" id="sNewSessions">+0 this week</div></div>
    <div class="stat-card"><div class="val" id="sCompleted">0</div><div class="label">Completed</div></div>
    <div class="stat-card"><div class="val" id="sAvgScore">-</div><div class="label">Avg Global Score</div></div>
    <div class="stat-card"><div class="val" id="sTokens">0</div><div class="label">Total Tokens Used</div></div>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <div class="tab active" onclick="switchTab('users')">ðŸ‘¥ Users</div>
    <div class="tab" onclick="switchTab('scenarios')">ðŸŽ® Scenarios</div>
    <div class="tab" onclick="switchTab('plans')">ðŸ’³ Plan Distribution</div>
  </div>

  <!-- USERS TAB -->
  <div class="tab-content active" id="tab-users">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <input type="text" id="userSearch" placeholder="Search users..." onkeyup="filterUsers()" style="padding:8px 14px;background:var(--bg-card);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:13px;width:300px;font-family:inherit;">
      <span id="userCount" style="font-size:13px;color:var(--text-muted);"></span>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Name</th><th>Email</th><th>Plan</th><th>Sessions</th><th>Avg Score</th><th>Joined</th><th>Actions</th></tr></thead>
        <tbody id="usersTable"></tbody>
      </table>
    </div>
  </div>

  <!-- SCENARIOS TAB -->
  <div class="tab-content" id="tab-scenarios">
    <div class="table-wrap">
      <table>
        <thead><tr><th>Code</th><th>Title</th><th>Domain</th><th>Level</th><th>Sessions</th><th>Avg Score</th><th>Usage</th></tr></thead>
        <tbody id="scenariosTable"></tbody>
      </table>
    </div>
  </div>

  <!-- PLANS TAB -->
  <div class="tab-content" id="tab-plans">
    <div id="plansDist" style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:16px;"></div>
  </div>
</main>

<!-- EDIT USER MODAL -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <h2>Edit User</h2>
    <input type="hidden" id="editUserId">
    <div class="form-row">
      <div class="form-group"><label>Name</label><input type="text" id="editName"></div>
      <div class="form-group"><label>Email</label><input type="email" id="editEmail"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Organization</label><input type="text" id="editOrg"></div>
      <div class="form-group">
        <label>Plan</label>
        <select id="editPlan"><option value="free">Free</option><option value="pro_monthly">Pro Monthly</option><option value="pro_lifetime">Pro Lifetime</option></select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Experience Level</label>
        <select id="editLevel"><option value="beginner">Beginner</option><option value="intermediate">Intermediate</option><option value="advanced">Advanced</option></select>
      </div>
      <div class="form-group"><label>Sim Limit</label><input type="number" id="editLimit" min="1"></div>
    </div>
    <div class="form-group">
      <label><input type="checkbox" id="editAdmin" style="margin-right:6px;">Admin access</label>
    </div>
    <div class="modal-actions">
      <button class="btn" style="background:var(--bg-secondary);color:var(--text-secondary);border:1px solid var(--border);" onclick="closeEdit()">Cancel</button>
      <button class="btn btn-primary" onclick="saveUser()">Save Changes</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const API = '';
const token = localStorage.getItem('auth_token');
if (!token) window.location.href = '/';
let allUsers = [];

async function init() {
  // Verify admin
  try {
    const res = await fetch(`${API}/api/auth/me`, { headers: { 'Authorization': `Bearer ${token}` } });
    const data = await res.json();
    if (!res.ok || !data.user.isAdmin) { window.location.href = '/dashboard'; return; }
  } catch(e) { window.location.href = '/'; return; }

  loadStats();
  loadUsers();
}

async function loadStats() {
  try {
    const res = await fetch(`${API}/api/admin/stats`, { headers: { 'Authorization': `Bearer ${token}` } });
    const data = await res.json();
    const o = data.overview;
    document.getElementById('sUsers').textContent = o.totalUsers;
    document.getElementById('sSessions').textContent = o.totalSessions;
    document.getElementById('sCompleted').textContent = o.completedSessions;
    document.getElementById('sAvgScore').textContent = o.avgGlobalScore || '-';
    document.getElementById('sTokens').textContent = o.totalTokensUsed.toLocaleString();
    document.getElementById('sNewUsers').textContent = `+${data.last7Days.newUsers} this week`;
    document.getElementById('sNewSessions').textContent = `+${data.last7Days.sessions} this week`;

    // Plan distribution
    const planDist = document.getElementById('plansDist');
    const colors = { free: '#64748b', pro_monthly: '#3b82f6', pro_lifetime: '#10b981' };
    planDist.innerHTML = (data.planDistribution || []).map(p => `
      <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:24px;text-align:center;">
        <div style="font-size:36px;font-weight:800;color:${colors[p.plan] || '#94a3b8'}">${p.count}</div>
        <div style="font-size:14px;font-weight:600;margin-top:4px;">${p.plan || 'free'}</div>
      </div>
    `).join('');

    // Scenario usage
    const scTable = document.getElementById('scenariosTable');
    const maxSessions = Math.max(...(data.scenarioUsage || []).map(s => parseInt(s.sessions) || 0), 1);
    scTable.innerHTML = (data.scenarioUsage || []).map(s => `
      <tr>
        <td><strong>${s.code}</strong></td>
        <td>${s.title_en}</td>
        <td>-</td><td>-</td>
        <td>${s.sessions}</td>
        <td>${s.avg_score || '-'}</td>
        <td><div class="sc-bar-bg"><div class="sc-bar" style="width:${(s.sessions/maxSessions)*100}%"></div></div></td>
      </tr>
    `).join('');
  } catch(e) { console.error('Stats error:', e); }
}

async function loadUsers() {
  try {
    const res = await fetch(`${API}/api/admin/users`, { headers: { 'Authorization': `Bearer ${token}` } });
    const data = await res.json();
    allUsers = data.users;
    renderUsers(allUsers);
    document.getElementById('userCount').textContent = `${data.total} users`;
  } catch(e) { console.error('Users error:', e); }
}

function renderUsers(users) {
  document.getElementById('usersTable').innerHTML = users.map(u => `
    <tr>
      <td><strong>${u.name || '-'}</strong>${u.isAdmin ? ' <span class="badge admin">admin</span>' : ''}</td>
      <td style="font-size:12px;color:var(--text-muted)">${u.email}</td>
      <td><span class="badge ${u.plan}">${u.plan}</span></td>
      <td>${u.sessions} (${u.completed} âœ“)</td>
      <td>${u.avgScore || '-'}</td>
      <td style="font-size:12px;color:var(--text-muted)">${u.joined}</td>
      <td>
        <button class="btn btn-sm" style="background:var(--bg-secondary);color:var(--accent-light);border:1px solid var(--border-accent);" onclick='openEdit(${JSON.stringify(u)})'>Edit</button>
        <button class="btn btn-danger btn-sm" onclick="deleteUser(${u.id},'${u.email}')">Delete</button>
      </td>
    </tr>
  `).join('');
}

function filterUsers() {
  const q = document.getElementById('userSearch').value.toLowerCase();
  renderUsers(allUsers.filter(u => u.name?.toLowerCase().includes(q) || u.email?.toLowerCase().includes(q) || u.organization?.toLowerCase().includes(q)));
}

function openEdit(user) {
  document.getElementById('editUserId').value = user.id;
  document.getElementById('editName').value = user.name || '';
  document.getElementById('editEmail').value = user.email || '';
  document.getElementById('editOrg').value = user.organization || '';
  document.getElementById('editPlan').value = user.plan || 'free';
  document.getElementById('editLevel').value = user.experienceLevel || 'beginner';
  document.getElementById('editLimit').value = user.simulationsLimit || 1;
  document.getElementById('editAdmin').checked = user.isAdmin || false;
  document.getElementById('editModal').classList.add('active');
}

function closeEdit() { document.getElementById('editModal').classList.remove('active'); }

async function saveUser() {
  const userId = parseInt(document.getElementById('editUserId').value);
  try {
    const res = await fetch(`${API}/api/admin/edit-user`, {
      method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
      body: JSON.stringify({
        userId,
        name: document.getElementById('editName').value,
        email: document.getElementById('editEmail').value,
        organization: document.getElementById('editOrg').value,
        plan: document.getElementById('editPlan').value,
        experienceLevel: document.getElementById('editLevel').value,
        simulationsLimit: parseInt(document.getElementById('editLimit').value),
        isAdmin: document.getElementById('editAdmin').checked
      })
    });
    const data = await res.json();
    if (!res.ok) { showToast(data.error, 'error'); return; }
    showToast('User updated', 'success');
    closeEdit();
    loadUsers();
  } catch(e) { showToast('Failed to save', 'error'); }
}

async function deleteUser(id, email) {
  if (!confirm(`Delete user ${email}? This removes ALL their data permanently.`)) return;
  try {
    const res = await fetch(`${API}/api/admin/delete-user`, {
      method: 'DELETE', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
      body: JSON.stringify({ userId: id })
    });
    if (!res.ok) { const d = await res.json(); showToast(d.error, 'error'); return; }
    showToast('User deleted', 'success');
    loadUsers();
    loadStats();
  } catch(e) { showToast('Failed to delete', 'error'); }
}

function switchTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById(`tab-${name}`).classList.add('active');
}

function logout() { localStorage.removeItem('auth_token'); window.location.href = '/'; }
function showToast(msg, type) { const t = document.getElementById('toast'); t.textContent = msg; t.className = `toast ${type} show`; setTimeout(() => t.classList.remove('show'), 3500); }

init();
</script>
</body>
</html>
