<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ClaudeSim ‚Äî Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root { --bg-primary:#0a0f1e;--bg-secondary:#0f172a;--bg-card:#151d30;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--text-muted:#64748b;--accent:#2563eb;--accent-light:#3b82f6;--accent-glow:rgba(37,99,235,0.3);--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--border:rgba(255,255,255,0.08);--border-accent:rgba(37,99,235,0.3); }
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Inter',sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;}
a{color:var(--accent-light);text-decoration:none;}
.container{max-width:1100px;margin:0 auto;padding:0 24px;}

/* NAV */
nav{background:var(--bg-secondary);border-bottom:1px solid var(--border);padding:14px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;}
.nav-logo{font-size:20px;font-weight:800;} .nav-logo span{color:var(--accent-light);}
.nav-right{display:flex;align-items:center;gap:16px;}
.nav-right a{font-size:14px;color:var(--text-secondary);}
.nav-right a:hover{color:var(--text-primary);}
.btn{padding:10px 20px;border-radius:8px;font-weight:600;font-size:14px;cursor:pointer;border:none;font-family:inherit;transition:all 0.2s;}
.btn-primary{background:linear-gradient(135deg,#1e3a5f,#2563eb);color:white;box-shadow:0 4px 20px var(--accent-glow);}
.btn-primary:hover{transform:translateY(-2px);}
.btn-secondary{background:transparent;color:var(--text-primary);border:1px solid var(--border);}
.btn-sm{padding:6px 14px;font-size:12px;}
.badge-plan{display:inline-block;padding:3px 10px;border-radius:999px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;}
.badge-plan.free{background:rgba(100,116,139,0.2);color:var(--text-muted);}
.badge-plan.pro{background:rgba(37,99,235,0.15);color:var(--accent-light);}

/* MAIN */
main{padding:40px 0;}
.welcome{margin-bottom:40px;}
.welcome h1{font-size:28px;font-weight:800;margin-bottom:4px;}
.welcome p{font-size:15px;color:var(--text-secondary);}

/* STATS */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:40px;}
.stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;}
.stat-card .val{font-size:32px;font-weight:800;color:var(--accent-light);}
.stat-card .label{font-size:12px;color:var(--text-muted);margin-top:4px;}

/* COMPETENCIES RADAR */
.comp-section{margin-bottom:40px;}
.comp-section h2{font-size:20px;font-weight:700;margin-bottom:20px;}
.comp-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;}
.comp-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center;}
.comp-card .code{font-size:14px;font-weight:800;color:var(--accent-light);margin-bottom:4px;}
.comp-card .name{font-size:11px;color:var(--text-muted);margin-bottom:10px;}
.comp-card .score{font-size:28px;font-weight:800;}
.comp-card .bar{height:4px;background:rgba(255,255,255,0.06);border-radius:2px;margin-top:8px;overflow:hidden;}
.comp-card .bar-fill{height:100%;background:var(--accent);border-radius:2px;transition:width 0.5s;}

/* SCENARIOS */
.scenarios-section h2{font-size:20px;font-weight:700;margin-bottom:20px;}
.scenario-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;margin-bottom:40px;}
.sc-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;transition:all 0.3s;cursor:pointer;}
.sc-card:hover{border-color:var(--border-accent);transform:translateY(-2px);}
.sc-meta{display:flex;gap:6px;margin-bottom:8px;}
.sc-tag{font-size:10px;padding:2px 8px;border-radius:999px;font-weight:600;text-transform:uppercase;}
.sc-tag.domain{background:rgba(37,99,235,0.15);color:var(--accent-light);}
.sc-tag.level{background:rgba(16,185,129,0.15);color:#34d399;}
.sc-tag.free{background:rgba(245,158,11,0.15);color:#fbbf24;}
.sc-tag.pro{background:rgba(100,116,139,0.15);color:var(--text-muted);}
.sc-card h3{font-size:15px;font-weight:700;margin-bottom:6px;line-height:1.3;}
.sc-card p{font-size:12px;color:var(--text-secondary);}
.sc-footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px;padding-top:10px;border-top:1px solid var(--border);}
.sc-footer span{font-size:11px;color:var(--text-muted);}

/* SESSIONS */
.sessions-section h2{font-size:20px;font-weight:700;margin-bottom:20px;}
.session-table{width:100%;border-collapse:collapse;}
.session-table th{text-align:left;font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);padding:10px 12px;border-bottom:1px solid var(--border);}
.session-table td{padding:12px;font-size:13px;border-bottom:1px solid var(--border);}
.session-table tr:hover td{background:rgba(37,99,235,0.04);}
.status-badge{padding:3px 8px;border-radius:999px;font-size:10px;font-weight:700;text-transform:uppercase;}
.status-badge.completed{background:rgba(16,185,129,0.15);color:#34d399;}
.status-badge.active{background:rgba(245,158,11,0.15);color:#fbbf24;}
.status-badge.abandoned{background:rgba(100,116,139,0.15);color:var(--text-muted);}
.score-circle{display:inline-flex;width:36px;height:36px;border-radius:50%;align-items:center;justify-content:center;font-size:13px;font-weight:800;background:rgba(37,99,235,0.15);color:var(--accent-light);}

.empty-state{text-align:center;padding:60px 20px;color:var(--text-muted);}
.empty-state .icon{font-size:48px;margin-bottom:12px;}
.empty-state p{font-size:15px;margin-bottom:20px;}
.toast{position:fixed;top:60px;right:20px;padding:12px 20px;border-radius:8px;font-size:14px;z-index:100;transform:translateX(150%);transition:transform 0.3s;}
.toast.show{transform:translateX(0);}.toast.success{background:#065f46;color:#a7f3d0;border:1px solid #10b981;}.toast.error{background:#7f1d1d;color:#fecaca;border:1px solid #ef4444;}

@media(max-width:768px){.stats-grid{grid-template-columns:repeat(2,1fr);}.comp-grid{grid-template-columns:repeat(3,1fr);}.scenario-list{grid-template-columns:1fr;}}
</style>
</head>
<body>

<nav>
  <a href="/" class="nav-logo">Claude<span>Sim</span></a>
  <div class="nav-right">
    <a href="/">Home</a>
    <span id="userPlan"></span>
    <span id="userName" style="font-size:14px;color:var(--text-secondary)"></span>
    <a href="#" onclick="logout()" style="font-size:13px;color:var(--text-muted)">Logout</a>
  </div>
</nav>

<main class="container">
  <div class="welcome">
    <h1 id="welcomeTitle">Welcome back!</h1>
    <p id="welcomeSub">Continue your AI literacy journey</p>
  </div>

  <!-- STATS -->
  <div class="stats-grid" id="statsGrid">
    <div class="stat-card"><div class="val" id="statSessions">0</div><div class="label">Total Sessions</div></div>
    <div class="stat-card"><div class="val" id="statCompleted">0</div><div class="label">Completed</div></div>
    <div class="stat-card"><div class="val" id="statAvgScore">-</div><div class="label">Avg Score</div></div>
    <div class="stat-card"><div class="val" id="statRemaining">-</div><div class="label">Simulations Left</div></div>
  </div>

  <!-- COMPETENCIES -->
  <div class="comp-section">
    <h2>Your Competencies</h2>
    <div class="comp-grid" id="compGrid">
      <div class="comp-card"><div class="code">C1</div><div class="name">Clarity</div><div class="score" id="compC1">-</div><div class="bar"><div class="bar-fill" id="compBarC1" style="width:0%"></div></div></div>
      <div class="comp-card"><div class="code">C2</div><div class="name">Techniques</div><div class="score" id="compC2">-</div><div class="bar"><div class="bar-fill" id="compBarC2" style="width:0%"></div></div></div>
      <div class="comp-card"><div class="code">C3</div><div class="name">Iteration</div><div class="score" id="compC3">-</div><div class="bar"><div class="bar-fill" id="compBarC3" style="width:0%"></div></div></div>
      <div class="comp-card"><div class="code">C4</div><div class="name">Critical</div><div class="score" id="compC4">-</div><div class="bar"><div class="bar-fill" id="compBarC4" style="width:0%"></div></div></div>
      <div class="comp-card"><div class="code">C5</div><div class="name">Efficiency</div><div class="score" id="compC5">-</div><div class="bar"><div class="bar-fill" id="compBarC5" style="width:0%"></div></div></div>
      <div class="comp-card"><div class="code">C6</div><div class="name">Ethics</div><div class="score" id="compC6">-</div><div class="bar"><div class="bar-fill" id="compBarC6" style="width:0%"></div></div></div>
    </div>
  </div>

  <!-- AVAILABLE SCENARIOS -->
  <div class="scenarios-section">
    <h2>Available Scenarios</h2>
    <div class="scenario-list" id="scenarioList"></div>
  </div>

  <!-- SESSION HISTORY -->
  <div class="sessions-section">
    <h2>Session History</h2>
    <div id="sessionsContainer"></div>
  </div>
</main>

<div class="toast" id="toast"></div>

<script>
const API = '';
const token = localStorage.getItem('auth_token');
if (!token) window.location.href = '/?error=auth_required';
const lang = localStorage.getItem('claudesim_lang') || 'en';
let userData = null;

async function init() {
  // Check payment success
  const params = new URLSearchParams(window.location.search);
  if (params.get('payment') === 'success') showToast('Payment successful! Welcome to Pro.', 'success');

  // Load user
  try {
    const res = await fetch(`${API}/api/auth/me`, { headers: { 'Authorization': `Bearer ${token}` } });
    if (!res.ok) { window.location.href = '/'; return; }
    const data = await res.json();
    userData = data.user;
    document.getElementById('userName').textContent = userData.name;
    document.getElementById('welcomeTitle').textContent = `Welcome back, ${userData.name.split(' ')[0]}!`;
    document.getElementById('userPlan').innerHTML = `<span class="badge-plan ${userData.plan}">${userData.plan}</span>`;
  } catch(e) { window.location.href = '/'; return; }

  loadDashboard();
  loadScenarios();
}

async function loadDashboard() {
  try {
    const res = await fetch(`${API}/api/user/dashboard`, { headers: { 'Authorization': `Bearer ${token}` } });
    const data = await res.json();

    // Stats
    document.getElementById('statSessions').textContent = data.stats.totalSessions;
    document.getElementById('statCompleted').textContent = data.stats.completedSessions;
    document.getElementById('statAvgScore').textContent = data.stats.avgScore || '-';
    const remaining = (userData.simulationsLimit || 1) - (userData.simulationsUsed || 0);
    document.getElementById('statRemaining').textContent = Math.max(0, remaining);

    // Competencies
    data.progress.forEach(p => {
      const key = p.competency;
      const el = document.getElementById(`comp${key}`);
      const bar = document.getElementById(`compBar${key}`);
      if (el) el.textContent = p.level + '/5';
      if (bar) bar.style.width = (p.level / 5 * 100) + '%';
    });

    // Sessions
    const container = document.getElementById('sessionsContainer');
    if (data.sessions.length === 0) {
      container.innerHTML = '<div class="empty-state"><div class="icon">üéÆ</div><p>No sessions yet. Start your first simulation!</p></div>';
    } else {
      container.innerHTML = `<table class="session-table"><thead><tr><th>Scenario</th><th>Domain</th><th>Status</th><th>Score</th><th>Date</th><th></th></tr></thead><tbody>${data.sessions.map(s => `
        <tr>
          <td><strong>${lang === 'fr' ? s.title_fr : s.title_en}</strong></td>
          <td><span class="sc-tag domain">${s.domain}</span></td>
          <td><span class="status-badge ${s.status}">${s.status}</span></td>
          <td>${s.status === 'completed' ? `<span class="score-circle">${s.scoreGlobal}</span>` : '-'}</td>
          <td style="font-size:12px;color:var(--text-muted)">${new Date(s.startedAt).toLocaleDateString()}</td>
          <td>${s.status === 'active' ? `<a href="/simulation?session=${s.id}" class="btn btn-sm btn-primary">Resume</a>` : s.status === 'completed' ? `<a href="/debrief?session=${s.id}" class="btn btn-sm btn-secondary">Debrief</a>` : ''}</td>
        </tr>`).join('')}</tbody></table>`;
    }
  } catch(e) { console.error('Dashboard error:', e); }
}

async function loadScenarios() {
  try {
    const res = await fetch(`${API}/api/scenarios`);
    const data = await res.json();
    const list = document.getElementById('scenarioList');
    list.innerHTML = data.scenarios.map(s => `
      <div class="sc-card" onclick="startScenario(${s.id}, ${s.is_free})">
        <div class="sc-meta">
          <span class="sc-tag domain">${s.domain}</span>
          <span class="sc-tag level">${s.level}</span>
          ${s.is_free ? '<span class="sc-tag free">FREE</span>' : '<span class="sc-tag pro">PRO</span>'}
        </div>
        <h3>${lang === 'fr' ? s.title_fr : s.title_en}</h3>
        <p>${(lang === 'fr' ? (s.description_fr || s.description_en) : s.description_en).substring(0, 100)}...</p>
        <div class="sc-footer">
          <span>‚è± ${s.duration_min} min</span>
          <span>${(s.competencies || []).join(', ')}</span>
        </div>
      </div>
    `).join('');
  } catch(e) { console.error('Scenarios error:', e); }
}

function startScenario(id, isFree) {
  if (!isFree && userData.plan === 'free') {
    showToast('This scenario requires a Pro plan. Upgrade to access it.', 'error');
    return;
  }
  window.location.href = `/simulation?scenario=${id}`;
}

function logout() { localStorage.removeItem('auth_token'); window.location.href = '/'; }
function showToast(msg, type) { const t = document.getElementById('toast'); t.textContent = msg; t.className = `toast ${type} show`; setTimeout(() => t.classList.remove('show'), 3500); }

init();
</script>
</body>
</html>
