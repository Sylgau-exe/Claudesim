<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ClaudeSim ‚Äî Simulation</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg-primary: #0a0f1e; --bg-secondary: #0f172a; --bg-card: #151d30; --bg-input: #111827;
  --text-primary: #f1f5f9; --text-secondary: #cbd5e1; --text-muted: #94a3b8;
  --accent: #2563eb; --accent-light: #3b82f6; --accent-glow: rgba(37,99,235,0.3);
  --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
  --border: rgba(255,255,255,0.08); --border-accent: rgba(37,99,235,0.3);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }

/* ==============================
   PHASE 1: FULL-SCREEN BRIEF
   ============================== */
.brief-screen { min-height: 100vh; display: flex; flex-direction: column; }
.brief-screen.hidden { display: none; }

.brief-nav { display: flex; align-items: center; justify-content: space-between; padding: 16px 32px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); }
.brief-nav-logo { font-size: 20px; font-weight: 800; }
.brief-nav-logo span { color: var(--accent-light); }
.brief-nav-back { color: var(--text-secondary); font-size: 14px; text-decoration: none; display: flex; align-items: center; gap: 6px; }
.brief-nav-back:hover { color: var(--text-primary); }

.brief-hero { text-align: center; padding: 60px 32px 40px; position: relative; }
.brief-hero::before { content: ''; position: absolute; top: -100px; left: 50%; transform: translateX(-50%); width: 600px; height: 600px; background: radial-gradient(ellipse, rgba(37,99,235,0.1) 0%, transparent 70%); pointer-events: none; }
.brief-badge { display: inline-flex; align-items: center; gap: 8px; padding: 6px 16px; background: rgba(37,99,235,0.12); border: 1px solid var(--border-accent); border-radius: 999px; font-size: 13px; color: var(--accent-light); font-weight: 600; margin-bottom: 20px; }
.brief-hero h1 { font-size: clamp(28px, 4vw, 40px); font-weight: 800; line-height: 1.2; margin-bottom: 12px; max-width: 700px; margin-left: auto; margin-right: auto; }
.brief-hero-sub { font-size: 17px; color: var(--text-secondary); max-width: 600px; margin: 0 auto; line-height: 1.6; }

.brief-meta-bar { display: flex; justify-content: center; gap: 32px; padding: 24px 32px; flex-wrap: wrap; }
.brief-meta { text-align: center; }
.brief-meta-val { font-size: 22px; font-weight: 800; color: var(--accent-light); }
.brief-meta-label { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }

.brief-content { max-width: 900px; margin: 0 auto; padding: 20px 32px 60px; display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }

.brief-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 28px; }
.brief-card.full { grid-column: 1 / -1; }
.brief-card-icon { font-size: 28px; margin-bottom: 12px; }
.brief-card h3 { font-size: 16px; font-weight: 700; margin-bottom: 14px; color: var(--text-primary); }
.brief-card p { font-size: 15px; color: var(--text-secondary); line-height: 1.7; }

.brief-criteria-list { list-style: none; padding: 0; }
.brief-criteria-list li { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 15px; color: var(--text-secondary); }
.brief-criteria-list li:last-child { border-bottom: none; }
.brief-criteria-weight { font-weight: 700; color: var(--accent-light); font-size: 14px; }

.brief-comp-grid { display: flex; flex-wrap: wrap; gap: 10px; }
.brief-comp-tag { padding: 8px 16px; background: rgba(37,99,235,0.1); border: 1px solid var(--border-accent); border-radius: 8px; font-size: 14px; font-weight: 600; color: var(--accent-light); }

.brief-start-area { text-align: center; padding: 40px 32px 60px; }
.brief-start-btn { display: inline-flex; align-items: center; gap: 10px; padding: 16px 48px; background: linear-gradient(135deg, #1e3a5f, #2563eb); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: 700; cursor: pointer; font-family: inherit; transition: all 0.3s; box-shadow: 0 6px 30px var(--accent-glow); }
.brief-start-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 40px var(--accent-glow); }
.brief-start-hint { font-size: 14px; color: var(--text-muted); margin-top: 12px; }

/* ==============================
   PHASE 2: SIMULATION INTERFACE
   ============================== */
.sim-screen { display: none; height: 100vh; flex-direction: column; overflow: hidden; }
.sim-screen.active { display: flex; }

.topbar { display: flex; align-items: center; justify-content: space-between; padding: 10px 20px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); height: 52px; flex-shrink: 0; }
.topbar-left { display: flex; align-items: center; gap: 16px; }
.topbar-logo { font-size: 18px; font-weight: 800; }
.topbar-logo span { color: var(--accent-light); }
.topbar-scenario { font-size: 14px; color: var(--text-secondary); max-width: 400px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.topbar-center { display: flex; align-items: center; gap: 16px; }
.topbar-timer { font-family: 'JetBrains Mono', monospace; font-size: 16px; font-weight: 600; color: var(--accent-light); background: rgba(37,99,235,0.1); padding: 4px 12px; border-radius: 6px; }
.topbar-prompts { font-size: 13px; color: var(--text-secondary); }
.topbar-score { font-size: 14px; font-weight: 700; color: var(--text-muted); background: rgba(255,255,255,0.05); padding: 4px 12px; border-radius: 6px; }
.topbar-score span { color: var(--accent-light); font-size: 18px; }

/* PER-PROMPT SCORE BADGE */
.prompt-score-badge { display: inline-flex; align-items: center; gap: 6px; margin-top: 8px; padding: 6px 12px; border-radius: 8px; font-size: 13px; font-weight: 600; animation: fadeIn 0.5s ease; }
.prompt-score-badge.low { background: rgba(239,68,68,0.12); color: #f87171; }
.prompt-score-badge.mid { background: rgba(245,158,11,0.12); color: #fbbf24; }
.prompt-score-badge.good { background: rgba(37,99,235,0.12); color: var(--accent-light); }
.prompt-score-badge.great { background: rgba(16,185,129,0.12); color: #34d399; }
.prompt-score-bar { width: 60px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
.prompt-score-fill { height: 100%; border-radius: 2px; transition: width 0.5s ease; }
.topbar-right { display: flex; align-items: center; gap: 12px; }
.btn { padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; font-family: inherit; transition: all 0.2s; }
.btn-brief { background: rgba(37,99,235,0.1); color: var(--accent-light); border: 1px solid var(--border-accent); }
.btn-brief:hover { background: rgba(37,99,235,0.2); }
.btn-submit { background: var(--success); color: white; }
.btn-submit:hover { background: #059669; }
.btn-abandon { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
.btn-abandon:hover { border-color: var(--danger); color: var(--danger); }

.sim-layout { display: grid; grid-template-columns: 1fr 400px; flex: 1; overflow: hidden; }

.panel-chat { display: flex; flex-direction: column; background: var(--bg-primary); overflow: hidden; }
.chat-header { padding: 12px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
.chat-header-dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; }
.chat-header span { font-size: 14px; color: var(--text-secondary); }
.chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; }
.msg { max-width: 80%; animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.msg-user { align-self: flex-end; }
.msg-assistant { align-self: flex-start; }
.msg-bubble { padding: 14px 18px; border-radius: 12px; font-size: 15px; line-height: 1.7; }
.msg-user .msg-bubble { background: var(--accent); color: white; border-bottom-right-radius: 4px; }
.msg-assistant .msg-bubble { background: var(--bg-card); border: 1px solid var(--border); border-bottom-left-radius: 4px; color: var(--text-primary); }
.msg-assistant .msg-bubble pre { background: var(--bg-input); padding: 10px; border-radius: 6px; overflow-x: auto; font-size: 13px; margin: 8px 0; font-family: 'JetBrains Mono', monospace; }
.msg-label { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

.chat-input-area { padding: 16px 20px; border-top: 1px solid var(--border); background: var(--bg-secondary); flex-shrink: 0; }
.chat-input-wrap { display: flex; gap: 10px; align-items: flex-end; }
.chat-input { flex: 1; background: var(--bg-input); border: 1px solid var(--border); border-radius: 10px; padding: 12px 16px; color: var(--text-primary); font-size: 15px; font-family: 'JetBrains Mono', monospace; resize: none; outline: none; min-height: 44px; max-height: 120px; transition: border-color 0.2s; }
.chat-input:focus { border-color: var(--accent); }
.chat-input::placeholder { color: var(--text-muted); }
.chat-send { width: 44px; height: 44px; background: var(--accent); border: none; border-radius: 10px; color: white; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
.chat-send:hover { background: var(--accent-light); }
.chat-send:disabled { opacity: 0.4; cursor: not-allowed; }

.panel-aria { background: var(--bg-secondary); border-left: 1px solid var(--border); overflow-y: auto; display: flex; flex-direction: column; }
.aria-header { padding: 20px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
.aria-top { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
.aria-avatar { width: 44px; height: 44px; border-radius: 10px; overflow: hidden; flex-shrink: 0; }
.aria-avatar img { width: 100%; height: 100%; object-fit: cover; }
.aria-name { font-size: 16px; font-weight: 700; }
.aria-role { font-size: 12px; color: var(--text-muted); }

.comp-scores { display: flex; flex-direction: column; gap: 8px; }
.comp-row { display: flex; align-items: center; gap: 10px; }
.comp-label { font-size: 13px; font-weight: 700; color: var(--accent-light); width: 28px; flex-shrink: 0; }
.comp-name { font-size: 12px; color: var(--text-secondary); width: 80px; flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.comp-bar-bg { flex: 1; height: 8px; background: rgba(255,255,255,0.08); border-radius: 4px; overflow: hidden; }
.comp-bar { height: 100%; background: var(--accent); border-radius: 4px; transition: width 0.5s ease; }
.comp-val { font-size: 14px; font-weight: 700; color: var(--text-primary); width: 22px; text-align: right; }

.aria-tips-area { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
.aria-tip { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 12px; animation: fadeIn 0.4s ease; }
.aria-tip-type { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; padding: 2px 8px; border-radius: 4px; display: inline-block; }
.aria-tip-type.nudge { background: rgba(245,158,11,0.15); color: #fbbf24; }
.aria-tip-type.micro-lesson { background: rgba(37,99,235,0.15); color: var(--accent-light); }
.aria-tip-type.alert { background: rgba(239,68,68,0.15); color: #f87171; }
.aria-tip-type.encouragement { background: rgba(16,185,129,0.15); color: #34d399; }
.aria-tip-type.redirect { background: rgba(168,85,247,0.15); color: #c084fc; }
.aria-tip-text { font-size: 15px; color: var(--text-secondary); line-height: 1.6; }
.aria-tip-num { font-size: 11px; color: var(--text-muted); margin-top: 6px; }

.aria-waiting { text-align: center; padding: 32px 0; }
.aria-waiting-icon { font-size: 32px; margin-bottom: 8px; }
.aria-waiting p { font-size: 14px; color: var(--text-muted); }

.aria-footer { padding: 12px 16px; border-top: 1px solid var(--border); flex-shrink: 0; }
.aria-hint-btn { width: 100%; padding: 10px; background: rgba(37,99,235,0.1); border: 1px solid var(--border-accent); border-radius: 8px; color: var(--accent-light); font-size: 13px; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s; }
.aria-hint-btn:hover { background: rgba(37,99,235,0.2); }

/* BRIEF DRAWER */
.brief-drawer { position: fixed; top: 0; left: 0; width: 420px; height: 100vh; background: var(--bg-secondary); border-right: 1px solid var(--border); z-index: 200; transform: translateX(-100%); transition: transform 0.3s ease; overflow-y: auto; padding: 24px; }
.brief-drawer.open { transform: translateX(0); }
.brief-drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 199; display: none; }
.brief-drawer-overlay.open { display: block; }
.brief-drawer-close { position: absolute; top: 16px; right: 16px; background: none; border: none; color: var(--text-muted); font-size: 22px; cursor: pointer; }
.brief-drawer h3 { font-size: 18px; font-weight: 700; margin-bottom: 16px; }
.brief-drawer p { font-size: 15px; color: var(--text-secondary); line-height: 1.7; margin-bottom: 20px; }
.brief-drawer h4 { font-size: 14px; font-weight: 700; margin-bottom: 10px; color: var(--text-primary); }
.brief-drawer ul { list-style: none; padding: 0; }
.brief-drawer li { padding: 8px 0; font-size: 14px; color: var(--text-secondary); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
.brief-drawer li:last-child { border-bottom: none; }

/* MISSION BANNER */
.mission-banner { background: linear-gradient(135deg, rgba(37,99,235,0.12), rgba(37,99,235,0.04)); border: 1px solid var(--border-accent); border-radius: 12px; padding: 16px 20px; margin-bottom: 8px; }
.mission-banner-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--accent-light); margin-bottom: 6px; }
.mission-banner-text { font-size: 15px; color: var(--text-primary); line-height: 1.6; }
.mission-banner-meta { display: flex; gap: 16px; margin-top: 10px; }
.mission-banner-tag { font-size: 12px; color: var(--text-muted); display: flex; align-items: center; gap: 4px; }

/* PROMPT SUGGESTIONS */
.prompt-suggestions { padding: 8px 0; animation: fadeIn 0.5s ease; }
.prompt-suggestions-label { font-size: 13px; color: var(--text-muted); margin-bottom: 12px; font-weight: 600; }
.prompt-suggestion { display: block; width: 100%; text-align: left; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 14px 16px; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px; line-height: 1.5; cursor: pointer; font-family: inherit; transition: all 0.2s; }
.prompt-suggestion:hover { border-color: var(--accent); background: rgba(37,99,235,0.08); color: var(--text-primary); }
.prompt-suggestion .suggestion-tag { display: inline-block; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; padding: 2px 8px; border-radius: 4px; margin-bottom: 6px; }
.prompt-suggestion .suggestion-tag.beginner { background: rgba(16,185,129,0.15); color: #34d399; }
.prompt-suggestion .suggestion-tag.intermediate { background: rgba(245,158,11,0.15); color: #fbbf24; }
.prompt-suggestion .suggestion-tag.advanced { background: rgba(168,85,247,0.15); color: #c084fc; }
.prompt-suggestion .suggestion-tag.custom { background: rgba(37,99,235,0.15); color: var(--accent-light); }
.prompt-suggestion-text { display: block; }

/* ITERATION GUIDE */
.iteration-guide { background: rgba(245,158,11,0.1); border: 1px dashed rgba(245,158,11,0.4); border-radius: 10px; padding: 12px 16px; font-size: 14px; color: #fbbf24; line-height: 1.5; margin-top: 4px; animation: fadeIn 0.5s ease; }
.iteration-guide.ready { background: rgba(16,185,129,0.08); border-color: rgba(16,185,129,0.3); color: #34d399; }

.typing-indicator { display: flex; gap: 4px; padding: 8px 0; }
.typing-dot { width: 6px; height: 6px; background: var(--text-muted); border-radius: 50%; animation: bounce 1.4s infinite; }
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes bounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }

.toast { position: fixed; top: 60px; right: 20px; padding: 12px 20px; border-radius: 8px; font-size: 14px; z-index: 300; transform: translateX(150%); transition: transform 0.3s; }
.toast.show { transform: translateX(0); }
.toast.success { background: #065f46; color: #a7f3d0; border: 1px solid #10b981; }
.toast.error { background: #7f1d1d; color: #fecaca; border: 1px solid #ef4444; }

@media (max-width: 900px) {
  .sim-layout { grid-template-columns: 1fr; }
  .panel-aria { display: none; }
  .brief-content { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<!-- PHASE 1: FULL-SCREEN BRIEF -->
<div class="brief-screen" id="briefScreen">
  <div class="brief-nav">
    <div class="brief-nav-logo">Claude<span>Sim</span></div>
    <a href="/dashboard" class="brief-nav-back">‚Üê Back to Dashboard</a>
  </div>
  <div class="brief-hero">
    <div class="brief-badge" id="briefBadge">
      <span id="briefDomain">Communication</span> ¬∑ <span id="briefLevel">Beginner</span>
    </div>
    <h1 id="briefTitle">Loading scenario...</h1>
    <p class="brief-hero-sub" id="briefDescription">Loading...</p>
  </div>
  <div class="brief-meta-bar">
    <div class="brief-meta"><div class="brief-meta-val" id="briefDuration">15</div><div class="brief-meta-label">Minutes</div></div>
    <div class="brief-meta"><div class="brief-meta-val" id="briefCompCount">2</div><div class="brief-meta-label">Competencies</div></div>
    <div class="brief-meta"><div class="brief-meta-val" id="briefCritCount">5</div><div class="brief-meta-label">Criteria</div></div>
  </div>
  <div class="brief-content">
    <div class="brief-card full">
      <div class="brief-card-icon">üéØ</div>
      <h3 id="missionLabel">Your Mission</h3>
      <p id="briefMission">Loading...</p>
    </div>
    <div class="brief-card">
      <div class="brief-card-icon">üìã</div>
      <h3 id="criteriaLabel">Evaluation Criteria</h3>
      <ul class="brief-criteria-list" id="briefCriteria"></ul>
    </div>
    <div class="brief-card">
      <div class="brief-card-icon"><img src="/aria.png" alt="ARIA" style="width:36px;height:36px;border-radius:8px;"></div>
      <h3 id="compTargetLabel">Competencies Targeted</h3>
      <div class="brief-comp-grid" id="briefCompetencies"></div>
      <p style="font-size:14px;color:var(--text-muted);margin-top:14px;" id="compExplain">ARIA will coach you on these competencies in real-time as you work.</p>
    </div>
  </div>
  <div class="brief-start-area">
    <button class="brief-start-btn" onclick="launchSimulation()" id="briefStartBtn">Begin Simulation ‚Üí</button>
    <div class="brief-start-hint" id="briefHint">You'll interact with Claude in a split-screen interface with ARIA coaching you in real-time.</div>
  </div>
</div>

<!-- PHASE 2: SIMULATION -->
<div class="sim-screen" id="simScreen">
  <div class="topbar">
    <div class="topbar-left">
      <div class="topbar-logo">Claude<span>Sim</span></div>
      <div class="topbar-scenario" id="topScenario">Scenario</div>
    </div>
    <div class="topbar-center">
      <button class="btn btn-brief" onclick="toggleBriefDrawer()">üìã View Brief</button>
      <div class="topbar-timer" id="topTimer">00:00</div>
      <div class="topbar-prompts" id="topPrompts">Prompts: 0</div>
      <div class="topbar-score" id="topScore" style="display:none;">
        <span id="topScoreVal">0</span>/100
      </div>
    </div>
    <div class="topbar-right">
      <button class="btn btn-abandon" onclick="abandonSim()">‚úï Abandon</button>
      <button class="btn btn-submit" onclick="completeSim()" id="btnSubmit" style="opacity:0.5;">‚úì Submit (3 more)</button>
    </div>
  </div>
  <div class="sim-layout">
    <div class="panel-chat">
      <div class="chat-header"><div class="chat-header-dot"></div><span>Claude ‚Äî Ready</span></div>
      <div class="chat-messages" id="chatMessages">
        <div class="msg msg-assistant">
          <div class="msg-label">Claude</div>
          <div class="msg-bubble" id="welcomeMsg">Welcome! I'm ready to help you with this scenario. Choose a suggested prompt below, or write your own.</div>
        </div>
        <div class="mission-banner" id="missionBanner" style="display:none;">
          <div class="mission-banner-label">üéØ <span id="missionBannerLabel">Your Mission</span></div>
          <div class="mission-banner-text" id="missionBannerText"></div>
          <div class="mission-banner-meta">
            <span class="mission-banner-tag">‚è± <span id="missionDuration"></span></span>
            <span class="mission-banner-tag">üìä <span id="missionLevel"></span></span>
          </div>
        </div>
        <div class="prompt-suggestions" id="promptSuggestions"></div>
      </div>
      <div class="chat-input-area">
        <div class="chat-input-wrap">
          <textarea class="chat-input" id="chatInput" placeholder="Write your prompt to Claude..." rows="1" onkeydown="handleKeydown(event)"></textarea>
          <button class="chat-send" id="chatSend" onclick="sendMessage()">‚Üí</button>
        </div>
      </div>
    </div>
    <div class="panel-aria">
      <div class="aria-header">
        <div class="aria-top">
          <div class="aria-avatar"><img src="/aria.png" alt="ARIA"></div>
          <div><div class="aria-name">ARIA</div><div class="aria-role">AI Readiness & Interaction Advisor</div></div>
        </div>
        <div class="comp-scores">
          <div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);font-weight:600;margin-bottom:4px;">Competencies</div>
          <div class="comp-row"><span class="comp-label">C1</span><span class="comp-name">Clarity</span><div class="comp-bar-bg"><div class="comp-bar" id="barC1" style="width:0%"></div></div><span class="comp-val" id="valC1">‚Äî</span></div>
          <div class="comp-row"><span class="comp-label">C2</span><span class="comp-name">Techniques</span><div class="comp-bar-bg"><div class="comp-bar" id="barC2" style="width:0%"></div></div><span class="comp-val" id="valC2">‚Äî</span></div>
          <div class="comp-row"><span class="comp-label">C3</span><span class="comp-name">Iteration</span><div class="comp-bar-bg"><div class="comp-bar" id="barC3" style="width:0%"></div></div><span class="comp-val" id="valC3">‚Äî</span></div>
          <div class="comp-row"><span class="comp-label">C4</span><span class="comp-name">Critical Eye</span><div class="comp-bar-bg"><div class="comp-bar" id="barC4" style="width:0%"></div></div><span class="comp-val" id="valC4">‚Äî</span></div>
          <div class="comp-row"><span class="comp-label">C5</span><span class="comp-name">Efficiency</span><div class="comp-bar-bg"><div class="comp-bar" id="barC5" style="width:0%"></div></div><span class="comp-val" id="valC5">‚Äî</span></div>
          <div class="comp-row"><span class="comp-label">C6</span><span class="comp-name">Ethics</span><div class="comp-bar-bg"><div class="comp-bar" id="barC6" style="width:0%"></div></div><span class="comp-val" id="valC6">‚Äî</span></div>
        </div>
      </div>
      <div class="aria-tips-area" id="ariaTips">
        <div class="aria-waiting"><div class="aria-waiting-icon"><img src="/aria.png" alt="ARIA" style="width:48px;height:48px;border-radius:12px;"></div><p>I'm watching. Send your first prompt and I'll analyze your technique.</p></div>
      </div>
      <div class="aria-footer"><button class="aria-hint-btn" onclick="requestHint()"><img src="/aria.png" alt="ARIA" style="width:20px;height:20px;border-radius:4px;vertical-align:middle;margin-right:6px;">Ask ARIA for a Hint</button></div>
    </div>
  </div>
</div>

<!-- BRIEF DRAWER -->
<div class="brief-drawer-overlay" id="drawerOverlay" onclick="toggleBriefDrawer()"></div>
<div class="brief-drawer" id="briefDrawer">
  <button class="brief-drawer-close" onclick="toggleBriefDrawer()">‚úï</button>
  <h3 id="drawerTitle">Scenario Brief</h3>
  <p id="drawerDescription"></p>
  <h4>Evaluation Criteria</h4>
  <ul id="drawerCriteria"></ul>
</div>

<div class="toast" id="toast"></div>

<script>
const API = '';
const token = localStorage.getItem('auth_token');
if (!token) window.location.href = '/?error=auth_required';

const lang = localStorage.getItem('claudesim_lang') || 'en';
const COMP_NAMES = {
  C1: lang==='fr' ? 'Clart√© du prompt' : 'Prompt Clarity',
  C2: lang==='fr' ? 'Techniques avanc√©es' : 'Advanced Techniques',
  C3: lang==='fr' ? 'It√©ration strat√©gique' : 'Strategic Iteration',
  C4: lang==='fr' ? 'Pens√©e critique' : 'Critical Thinking',
  C5: lang==='fr' ? 'Efficacit√©' : 'Efficiency',
  C6: lang==='fr' ? '√âthique & limites' : 'Ethics & Limits'
};

let sessionId = null, scenarioData = null, scenarioId = null;
let promptCount = 0, timerInterval = null, startTime = null, isLoading = false;
let promptScores = []; // Track each prompt's score

async function init() {
  const params = new URLSearchParams(window.location.search);
  scenarioId = params.get('scenario');
  sessionId = params.get('session');
  if (sessionId) { await resumeSession(sessionId); }
  else if (scenarioId) { await loadScenarioBrief(scenarioId); }
  else { window.location.href = '/dashboard'; }
}

async function loadScenarioBrief(id) {
  try {
    const res = await fetch(`${API}/api/scenarios`);
    const data = await res.json();
    scenarioData = data.scenarios.find(s => s.id == id);
    if (!scenarioData) { showToast('Scenario not found','error'); return; }
    populateBriefScreen();
  } catch(e) { showToast('Failed to load scenario','error'); }
}

function populateBriefScreen() {
  const s = scenarioData;
  const title = lang==='fr' ? s.title_fr : s.title_en;
  const desc = lang==='fr' ? (s.description_fr||s.description_en) : s.description_en;
  document.getElementById('briefTitle').textContent = title;
  document.getElementById('briefDescription').textContent = desc;
  document.getElementById('briefMission').textContent = desc;
  document.getElementById('briefDomain').textContent = s.domain;
  document.getElementById('briefLevel').textContent = s.level.charAt(0).toUpperCase()+s.level.slice(1);
  document.getElementById('briefDuration').textContent = s.duration_min||30;
  const criteria = s.evaluation_criteria||[];
  document.getElementById('briefCritCount').textContent = criteria.length;
  document.getElementById('briefCriteria').innerHTML = criteria.map(c=>`<li>${c.criterion} <span class="brief-criteria-weight">${c.weight}%</span></li>`).join('');
  const comps = s.competencies||[];
  document.getElementById('briefCompCount').textContent = comps.length;
  document.getElementById('briefCompetencies').innerHTML = comps.map(c=>`<div class="brief-comp-tag">${c} ‚Äî ${COMP_NAMES[c]||c}</div>`).join('');
  if (lang==='fr') {
    document.getElementById('missionLabel').textContent = 'Votre mission';
    document.getElementById('criteriaLabel').textContent = "Crit√®res d'√©valuation";
    document.getElementById('compTargetLabel').textContent = 'Comp√©tences cibl√©es';
    document.getElementById('compExplain').textContent = 'ARIA vous coachera sur ces comp√©tences en temps r√©el pendant votre travail.';
    document.getElementById('briefStartBtn').innerHTML = 'Commencer la simulation ‚Üí';
    document.getElementById('briefHint').textContent = "Vous interagirez avec Claude dans une interface partag√©e avec un coaching ARIA en temps r√©el.";
  }
}

async function launchSimulation() {
  const btn = document.getElementById('briefStartBtn');
  btn.disabled = true; btn.innerHTML = lang==='fr' ? 'Lancement...' : 'Launching...';
  try {
    const res = await fetch(`${API}/api/simulation/start`, {
      method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},
      body: JSON.stringify({ scenarioId })
    });
    const data = await res.json();
    if (!res.ok) { showToast(data.error,'error'); btn.disabled=false; btn.innerHTML='Begin Simulation ‚Üí'; return; }
    sessionId = data.session.id;
    scenarioData = data.scenario;
    history.replaceState(null,'',`/simulation?session=${sessionId}`);
    switchToSim();
  } catch(e) { showToast('Failed to start simulation','error'); btn.disabled=false; btn.innerHTML='Begin Simulation ‚Üí'; }
}

function switchToSim() {
  document.getElementById('briefScreen').classList.add('hidden');
  document.getElementById('simScreen').classList.add('active');
  document.body.style.overflow = 'hidden';
  const s = scenarioData;
  document.getElementById('topScenario').textContent = `${s.code||''} ‚Äî ${lang==='fr' ? s.title_fr : s.title_en}`;
  document.getElementById('drawerTitle').textContent = lang==='fr' ? s.title_fr : s.title_en;
  document.getElementById('drawerDescription').textContent = lang==='fr' ? (s.description_fr||s.description_en) : s.description_en;
  const criteria = s.evaluation_criteria||[];
  document.getElementById('drawerCriteria').innerHTML = criteria.map(c=>`<li>${c.criterion} <span class="brief-criteria-weight">${c.weight}%</span></li>`).join('');
  startTimer();
  // Show mission banner
  const desc = lang==='fr' ? (s.description_fr||s.description_en) : s.description_en;
  document.getElementById('missionBannerText').textContent = desc;
  document.getElementById('missionDuration').textContent = (s.duration_min||30) + (lang==='fr' ? ' min' : ' min');
  document.getElementById('missionLevel').textContent = s.level.charAt(0).toUpperCase() + s.level.slice(1);
  if (lang==='fr') document.getElementById('missionBannerLabel').textContent = 'Votre mission';
  document.getElementById('missionBanner').style.display = 'block';
  showPromptSuggestions();
  document.getElementById('welcomeMsg').textContent = lang==='fr'
    ? 'Bienvenue ! Choisissez un prompt sugg√©r√© ci-dessous, ou √©crivez le v√¥tre.'
    : 'Welcome! Choose a suggested prompt below, or write your own.';
  if (lang==='fr') {
    const frNames = ['Clart√©','Techniques','It√©ration','Esprit critique','Efficacit√©','√âthique'];
    document.querySelectorAll('.comp-name').forEach((el,i) => { if(frNames[i]) el.textContent = frNames[i]; });
  }
  document.getElementById('chatInput').focus();
}

async function resumeSession(sid) {
  try {
    const res = await fetch(`${API}/api/simulation/session?id=${sid}`, { headers:{'Authorization':`Bearer ${token}`} });
    const data = await res.json();
    if (!res.ok) { window.location.href='/dashboard'; return; }
    sessionId = data.session.id;
    const scRes = await fetch(`${API}/api/scenarios`);
    const scData = await scRes.json();
    scenarioData = scData.scenarios.find(s => s.id === data.session.scenarioId);
    document.getElementById('briefScreen').classList.add('hidden');
    document.getElementById('simScreen').classList.add('active');
    document.body.style.overflow = 'hidden';
    const s = scenarioData;
    document.getElementById('topScenario').textContent = `${s.code||''} ‚Äî ${lang==='fr'?s.title_fr:s.title_en}`;
    document.getElementById('drawerTitle').textContent = lang==='fr'?s.title_fr:s.title_en;
    document.getElementById('drawerDescription').textContent = lang==='fr'?(s.description_fr||s.description_en):s.description_en;
    const criteria = s.evaluation_criteria||[];
    document.getElementById('drawerCriteria').innerHTML = criteria.map(c=>`<li>${c.criterion} <span class="brief-criteria-weight">${c.weight}%</span></li>`).join('');
    const msgs = document.getElementById('chatMessages');
    msgs.innerHTML = '';
    data.interactions.forEach(i => {
      if (i.role==='user') { promptCount++; addMessage('user',i.content); }
      else if (i.role==='assistant') { addMessage('assistant',i.content); }
      else if (i.role==='coach') { try { const tip=JSON.parse(i.content); addAriaTip(tip.tip,tip.type,promptCount); if(tip.scores)updateScores(tip.scores); } catch(e){} }
    });
    document.getElementById('topPrompts').textContent = `Prompts: ${promptCount}`;
    startTimer(new Date(data.session.startedAt));
  } catch(e) { window.location.href='/dashboard'; }
}

function toggleBriefDrawer() {
  document.getElementById('briefDrawer').classList.toggle('open');
  document.getElementById('drawerOverlay').classList.toggle('open');
}

// ========================
// PROMPT SUGGESTIONS
// ========================
const SUGGESTIONS = {
  S01: {
    en: [
      { tag: 'beginner', text: 'Write me an email about the restructuring.' },
      { tag: 'intermediate', text: 'Write a professional email to all staff announcing that 2 departments will be restructured, affecting 45 employees. Use an empathetic but clear tone. Include next steps and a Q&A session date.' },
      { tag: 'advanced', text: 'Act as a corporate communications expert. Draft a 400-word internal email announcing an organizational restructuring affecting 45 employees across 2 departments. Structure: 1) Context & rationale, 2) What changes, 3) Support for affected employees, 4) Timeline & next steps. Tone: transparent, empathetic, forward-looking. Avoid jargon.' },
      { tag: 'custom', text: '‚úçÔ∏è Write my own prompt' }
    ],
    fr: [
      { tag: 'beginner', text: '√âcris-moi un courriel sur la restructuration.' },
      { tag: 'intermediate', text: 'R√©dige un courriel professionnel pour annoncer la restructuration de 2 d√©partements touchant 45 employ√©s. Utilise un ton empathique mais clair. Inclus les prochaines √©tapes et une date de s√©ance Q&R.' },
      { tag: 'advanced', text: 'Agis en expert en communications. R√©dige un courriel interne de 400 mots annon√ßant une restructuration touchant 45 employ√©s dans 2 d√©partements. Structure : 1) Contexte et justification, 2) Ce qui change, 3) Soutien aux employ√©s, 4) Calendrier et prochaines √©tapes. Ton : transparent, empathique, tourn√© vers l\'avenir.' },
      { tag: 'custom', text: '‚úçÔ∏è √âcrire mon propre prompt' }
    ]
  },
  S02: {
    en: [
      { tag: 'beginner', text: 'Analyze the Q3 sales data for me.' },
      { tag: 'intermediate', text: 'Analyze Q3 sales data and identify the top 3 trends. Compare to Q2 and highlight underperforming regions. Present as an executive summary.' },
      { tag: 'advanced', text: 'You are a senior business analyst. Analyze Q3 sales data: 1) Top 3 revenue trends with % changes vs Q2, 2) Underperforming segments with root cause hypotheses, 3) 3 actionable Q4 strategies, 4) Present as a 1-page executive summary with key metrics.' },
      { tag: 'custom', text: '‚úçÔ∏è Write my own prompt' }
    ],
    fr: [
      { tag: 'beginner', text: 'Analyse les donn√©es de ventes du T3.' },
      { tag: 'intermediate', text: 'Analyse les ventes du T3, identifie les 3 tendances principales. Compare au T2 et mets en √©vidence les r√©gions sous-performantes. Pr√©sente en r√©sum√© ex√©cutif.' },
      { tag: 'advanced', text: 'Tu es analyste senior. Analyse les ventes T3 : 1) 3 tendances de revenus avec variations vs T2, 2) Segments sous-performants avec hypoth√®ses, 3) 3 strat√©gies pour T4, 4) R√©sum√© ex√©cutif d\'une page avec m√©triques cl√©s.' },
      { tag: 'custom', text: '‚úçÔ∏è √âcrire mon propre prompt' }
    ]
  },
  S03: {
    en: [
      { tag: 'beginner', text: 'Help me create a 10-slide presentation for the board.' },
      { tag: 'intermediate', text: 'Create an outline for a 10-slide strategic board presentation covering: market position, competitive analysis, growth strategy, and financial projections. Include speaker notes.' },
      { tag: 'advanced', text: 'Act as VP of Strategy. Create a 10-slide board deck: Slide 1: Title. Slides 2-3: Market position (TAM/SAM/SOM). Slides 4-5: Competitive analysis (positioning + SWOT). Slides 6-7: Growth strategy (3 pillars with KPIs). Slides 8-9: 3-year financials. Slide 10: Ask & next steps. Include key message, data points, and speaker notes per slide.' },
      { tag: 'custom', text: '‚úçÔ∏è Write my own prompt' }
    ],
    fr: [
      { tag: 'beginner', text: 'Aide-moi √† cr√©er une pr√©sentation de 10 slides pour le CA.' },
      { tag: 'intermediate', text: 'Cr√©e un plan de pr√©sentation strat√©gique de 10 diapos : position de march√©, concurrence, strat√©gie de croissance et projections financi√®res. Inclus des notes d\'orateur.' },
      { tag: 'advanced', text: 'Agis en VP Strat√©gie. Cr√©e un deck de 10 diapos pour le CA : Diapo 1: Titre. 2-3: March√© (TAM/SAM/SOM). 4-5: Analyse concurrentielle (SWOT). 6-7: Croissance (3 piliers + KPIs). 8-9: Financier 3 ans. 10: Demande et √©tapes. Pour chaque diapo : message cl√©, donn√©es et notes.' },
      { tag: 'custom', text: '‚úçÔ∏è √âcrire mon propre prompt' }
    ]
  }
};

const TAG_LABELS = {
  en: { beginner: 'Basic', intermediate: 'Better', advanced: 'Expert', custom: 'Your Turn' },
  fr: { beginner: 'Basique', intermediate: 'Meilleur', advanced: 'Expert', custom: '√Ä vous' }
};

function showPromptSuggestions() {
  const code = scenarioData?.code;
  const container = document.getElementById('promptSuggestions');
  if (!container || !code || !SUGGESTIONS[code]) return;
  const suggestions = SUGGESTIONS[code][lang] || SUGGESTIONS[code]['en'];
  container.innerHTML = `<div class="prompt-suggestions-label">${lang==='fr' ? 'üí° Choisissez un prompt pour commencer, ou √©crivez le v√¥tre :' : 'üí° Choose a prompt to start with, or write your own:'}</div>` +
    suggestions.map((s, i) => `<button class="prompt-suggestion" onclick="useSuggestion(${i})"><span class="prompt-suggestion-text">${s.text}</span></button>`).join('');
}

function useSuggestion(index) {
  const code = scenarioData?.code;
  const suggestions = SUGGESTIONS[code]?.[lang] || SUGGESTIONS[code]?.['en'];
  if (!suggestions) return;
  const s = suggestions[index];
  document.getElementById('promptSuggestions')?.remove();
  if (s.tag === 'custom') {
    document.getElementById('chatInput').focus();
  } else {
    document.getElementById('chatInput').value = s.text;
    sendMessage();
  }
}

function handleKeydown(e) {
  if (e.key==='Enter'&&!e.shiftKey) { e.preventDefault(); sendMessage(); }
  e.target.style.height='auto';
  e.target.style.height=Math.min(e.target.scrollHeight,120)+'px';
}

async function sendMessage() {
  const input = document.getElementById('chatInput');
  const message = input.value.trim();
  if (!message||isLoading) return;
  isLoading=true;
  document.getElementById('chatSend').disabled=true;
  input.value=''; input.style.height='auto';
  promptCount++;
  document.getElementById('topPrompts').textContent=`Prompts: ${promptCount}`;
  document.getElementById('promptSuggestions')?.remove();
  // Update submit button state
  const MIN_PROMPTS = 3;
  const submitBtn = document.getElementById('btnSubmit');
  if (promptCount < MIN_PROMPTS) {
    submitBtn.textContent = `‚úì Submit (${MIN_PROMPTS - promptCount} more)`;
    submitBtn.style.opacity = '0.5';
  } else {
    submitBtn.textContent = '‚úì Submit Deliverable';
    submitBtn.style.opacity = '1';
  }
  addMessage('user',message);
  showTyping();
  try {
    const res = await fetch(`${API}/api/simulation/chat`, {
      method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},
      body: JSON.stringify({ sessionId, message })
    });
    const data = await res.json();
    hideTyping();
    if (!res.ok) { showToast(data.error,'error'); return; }
    addMessage('assistant',data.claude.content);
    if (data.aria) {
      addAriaTip(data.aria.tip, data.aria.type, data.promptNumber);
      if (data.aria.scores) updateScores(data.aria.scores);
      if (data.aria.prompt_score !== undefined) showPromptScore(data.aria.prompt_score, data.promptNumber);
    }
  } catch(e) { hideTyping(); showToast('Failed to send message.','error'); }
  finally { isLoading=false; document.getElementById('chatSend').disabled=false; document.getElementById('chatInput').focus(); }
}

function addMessage(role, content) {
  const container = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = `msg msg-${role}`;
  let html = content
    .replace(/```(\w*)\n([\s\S]*?)```/g,'<pre><code>$2</code></pre>')
    .replace(/`([^`]+)`/g,'<code style="background:rgba(37,99,235,0.15);padding:2px 6px;border-radius:4px;font-size:13px;">$1</code>')
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/\n/g,'<br>');
  div.innerHTML=`<div class="msg-label">${role==='user'?(lang==='fr'?'Vous':'You'):'Claude'}</div><div class="msg-bubble">${html}</div>`;
  container.appendChild(div);
  container.scrollTop=container.scrollHeight;
}

function showTyping() {
  const container=document.getElementById('chatMessages');
  const div=document.createElement('div');
  div.id='typingIndicator'; div.className='msg msg-assistant';
  div.innerHTML=`<div class="msg-label">Claude</div><div class="msg-bubble"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>`;
  container.appendChild(div); container.scrollTop=container.scrollHeight;
}
function hideTyping() { document.getElementById('typingIndicator')?.remove(); }

function addAriaTip(tip,type,num) {
  const container=document.getElementById('ariaTips');
  container.querySelector('.aria-waiting')?.remove();
  const div=document.createElement('div');
  div.className='aria-tip';
  div.innerHTML=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;"><img src="/aria.png" alt="ARIA" style="width:22px;height:22px;border-radius:5px;"><span class="aria-tip-type ${type||'nudge'}">${type||'nudge'}</span></div><div class="aria-tip-text">${tip}</div><div class="aria-tip-num">After prompt #${num}</div>`;
  container.appendChild(div); container.scrollTop=container.scrollHeight;
}

function updateScores(scores) {
  for (const [key,val] of Object.entries(scores)) {
    const num=key.replace('c','');
    const bar=document.getElementById(`barC${num}`);
    const valEl=document.getElementById(`valC${num}`);
    if(bar) bar.style.width=(val/5*100)+'%';
    if(valEl) {
      valEl.textContent=val+'/5';
      // Color code
      if (val >= 4) { valEl.style.color='#34d399'; bar.style.background='#10b981'; }
      else if (val >= 3) { valEl.style.color='#3b82f6'; bar.style.background='#2563eb'; }
      else if (val >= 2) { valEl.style.color='#fbbf24'; bar.style.background='#f59e0b'; }
      else { valEl.style.color='#f87171'; bar.style.background='#ef4444'; }
    }
  }
}

function showPromptScore(score, promptNum) {
  promptScores.push(score);
  const avg = Math.round(promptScores.reduce((a,b) => a+b, 0) / promptScores.length);

  let tier = 'low', color = '#f87171';
  if (score >= 80) { tier = 'great'; color = '#34d399'; }
  else if (score >= 60) { tier = 'good'; color = '#3b82f6'; }
  else if (score >= 40) { tier = 'mid'; color = '#fbbf24'; }

  const container = document.getElementById('chatMessages');
  const badge = document.createElement('div');
  badge.className = `prompt-score-badge ${tier}`;
  badge.innerHTML = `${lang==='fr' ? 'Score du prompt' : 'Prompt Score'}: ${score}/100 <div class="prompt-score-bar"><div class="prompt-score-fill" style="width:${score}%;background:${color}"></div></div>`;
  container.appendChild(badge);

  // Iteration guidance
  const MIN_PROMPTS = 3;
  if (promptCount < MIN_PROMPTS) {
    const guide = document.createElement('div');
    guide.className = 'iteration-guide';
    const remaining = MIN_PROMPTS - promptCount;
    let hint_en, hint_fr;
    if (promptCount === 1) {
      hint_en = `üìù Prompt ${promptCount}/3 ‚Äî Now review Claude's response. Is it exactly what you need? Refine your prompt to improve the result. (${remaining} more required)`;
      hint_fr = `üìù Prompt ${promptCount}/3 ‚Äî Examinez la r√©ponse de Claude. Est-ce exactement ce dont vous avez besoin ? Affinez votre prompt pour am√©liorer le r√©sultat. (${remaining} de plus requis)`;
    } else {
      hint_en = `üìù Prompt ${promptCount}/3 ‚Äî Good iteration! Keep refining. Add structure, constraints, or fix what's missing. (${remaining} more required)`;
      hint_fr = `üìù Prompt ${promptCount}/3 ‚Äî Bonne it√©ration ! Continuez √† affiner. Ajoutez de la structure, des contraintes, ou corrigez ce qui manque. (${remaining} de plus requis)`;
    }
    guide.textContent = lang==='fr' ? hint_fr : hint_en;
    container.appendChild(guide);
  } else if (promptCount === MIN_PROMPTS) {
    const guide = document.createElement('div');
    guide.className = 'iteration-guide ready';
    guide.textContent = lang==='fr'
      ? '‚úÖ Minimum atteint ! Vous pouvez soumettre ou continuer √† it√©rer pour un meilleur score.'
      : '‚úÖ Minimum reached! You can submit now or keep iterating for a better score.';
    container.appendChild(guide);
  }

  container.scrollTop = container.scrollHeight;

  // Update topbar average
  const topScore = document.getElementById('topScore');
  topScore.style.display = 'block';
  document.getElementById('topScoreVal').textContent = avg;
  if (avg >= 80) topScore.style.color = '#34d399';
  else if (avg >= 60) topScore.style.color = '#3b82f6';
  else if (avg >= 40) topScore.style.color = '#fbbf24';
  else topScore.style.color = '#f87171';
  document.getElementById('topScoreVal').style.color = 'inherit';
}

async function requestHint() {
  if(isLoading) return;
  addAriaTip(lang==='fr'
    ? "üí° Pensez au format de sortie souhait√©. √ätre pr√©cis sur la structure aide Claude √† livrer exactement ce dont vous avez besoin."
    : "üí° Think about what output format you want. Being specific about structure helps Claude deliver exactly what you need.",
    "micro-lesson", promptCount);
}

function startTimer(from) {
  startTime = from ? new Date(from) : new Date();
  timerInterval = setInterval(() => {
    const elapsed=Math.floor((Date.now()-startTime.getTime())/1000);
    const min=Math.floor(elapsed/60).toString().padStart(2,'0');
    const sec=(elapsed%60).toString().padStart(2,'0');
    document.getElementById('topTimer').textContent=`${min}:${sec}`;
  },1000);
}

async function completeSim() {
  const MIN_PROMPTS = 3;
  if(promptCount < MIN_PROMPTS){
    showToast(lang==='fr'
      ? `Vous devez envoyer au moins ${MIN_PROMPTS} prompts. It√©rez et am√©liorez votre r√©sultat ! (${promptCount}/${MIN_PROMPTS})`
      : `Send at least ${MIN_PROMPTS} prompts before submitting. Iterate and improve your result! (${promptCount}/${MIN_PROMPTS})`,
    'error');
    return;
  }
  if(!confirm(lang==='fr'?'Soumettre votre livrable et terminer?':'Submit deliverable and end simulation?'))return;
  document.getElementById('btnSubmit').disabled=true;
  document.getElementById('btnSubmit').textContent=lang==='fr'?'G√©n√©ration du d√©brief...':'Generating debrief...';
  clearInterval(timerInterval);
  try {
    const res=await fetch(`${API}/api/simulation/complete`,{
      method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},
      body:JSON.stringify({sessionId})
    });
    const data=await res.json();
    if(!res.ok){showToast(data.error,'error');return;}
    localStorage.setItem('claudesim_debrief',JSON.stringify(data.debrief));
    localStorage.setItem('claudesim_prompt_scores',JSON.stringify(promptScores));
    window.location.href=`/debrief?session=${sessionId}`;
  } catch(e) { showToast('Failed to complete simulation','error'); document.getElementById('btnSubmit').disabled=false; document.getElementById('btnSubmit').textContent='‚úì Submit Deliverable'; }
}

function abandonSim() {
  if(!confirm(lang==='fr'?'Abandonner cette simulation?':'Abandon this simulation?'))return;
  clearInterval(timerInterval);
  window.location.href='/dashboard';
}

function showToast(msg,type) {
  const t=document.getElementById('toast');
  t.textContent=msg; t.className=`toast ${type} show`;
  setTimeout(()=>t.classList.remove('show'),3500);
}

init();
</script>
</body>
</html>
